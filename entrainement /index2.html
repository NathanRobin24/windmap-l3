<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>D3 Globe (Orthographic)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <svg id="globe" width="700" height="700"></svg>

  <script>
    const width = 700, height = 700;
    const svg = d3.select("#globe");

    // Groupe principal (tout ce qu'on dessine)
    const g = svg.append("g");

    // Projection "globe"
    const projection = d3.geoOrthographic()
      .translate([width / 2, height / 2])
      .scale(300);

    // Path generator
    const path = d3.geoPath().projection(projection);

    // Un cercle pour "l'océan" (la sphère)
    const sphere = { type: "Sphere" };

    // Chargement du monde (GeoJSON)
    d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
      .then(world => {

        // Dessiner l'océan (sphère)
        g.append("path")
          .datum(sphere)
          .attr("class", "ocean")
          .attr("d", path)
          .attr("fill", "#dfefff")
          .attr("stroke", "#333")
          .attr("stroke-width", 1);

        // Dessiner les pays
        const countries = g.selectAll("path.country")
          .data(world.features)
          .enter()
          .append("path")
          .attr("class", "country")
          .attr("fill", "#cfcfcf")
          .attr("stroke", "#333")
          .attr("stroke-width", 0.5)
          .append("title")
          .text(d => d.properties.name);

        // Fonction de rendu (recalculer les paths à chaque rotation)
        function render() {
          g.selectAll("path.ocean").attr("d", path);
          g.selectAll("path.country").attr("d", path);
        }

        // Rotation auto (globe qui tourne)
        let rotate = projection.rotate(); // [lambda, phi, gamma]
        const timer = d3.timer(() => {
          rotate[0] += 0.15; // vitesse de rotation
          projection.rotate(rotate);
          render();
        });

        // Drag souris pour tourner à la main
        let last = null;

        svg.call(
          d3.drag()
            .on("start", (event) => {
              last = [event.x, event.y];
            })
            .on("drag", (event) => {
              const [x, y] = [event.x, event.y];
              const dx = x - last[0];
              const dy = y - last[1];

              // ajuster la rotation selon le mouvement
              rotate = projection.rotate();
              rotate[0] += dx * 0.3; // horizontal -> longitude
              rotate[1] -= dy * 0.3; // vertical -> latitude

              // limiter latitude pour éviter des inversions bizarres
              rotate[1] = Math.max(-90, Math.min(90, rotate[1]));

              projection.rotate(rotate);
              render();

              last = [x, y];
            })
            .on("end", () => {
              last = null;
            })
        );

        // 1er rendu
        render();
      });
  </script>
</body>
</html>
